import OpenAI from "openai"
import * as dotenv from "dotenv"
import path from "path"

const LOG_PREFIX = "[test-openai]"

// Load environment variables
const envLocalPath = path.resolve(process.cwd(), ".env.local")
console.log(`${LOG_PREFIX} Loading env from: ${envLocalPath}`)
dotenv.config({ path: envLocalPath, override: true })

const client = new OpenAI()

var userPrompt = `
役割: あなたは中立な編集者です。以下の「検証済み事実情報」を使ってweb検索し、2025年参院選 兵庫県選挙区に出馬の「泉房穂」のマニフェストを、シンプルなリストHTMLのみで作成してください。

出力制約:
- <ul>/<ol>/<li>のみ使用（必要に応じ<a>, <time>, <q>可）。見出しタグや<p>、スタイル、コメントは使わない。
- 事実情報に無い記述は禁止。不足は「情報未提供」と明記。
- 数値・固有名詞は出典と一致する場合のみ。
- 引用は短く<q>で可（出典URL・日付を併記）。

検証済み事実情報:
- 選挙名: 2025年参院選
- 年: 2025
- 選挙区: 兵庫
- 候補者: 泉房穂
- 所属: 無所属

出力構成（この順番・入れ子を厳守）:
<ul>
  <li>■要約：<ul><li><!-- 3〜5行 --></li></ul></li>
  <li>■公約：<ul><!-- 最大7項目 --></ul></li>
  <li>■具体策：
    <ul>
      <li>経済・物価：<ul><!-- 箇条書き --></ul></li>
      <li>子育て・教育：<ul><!-- 箇条書き --></ul></li>
      <li>社会保障：<ul><!-- 箇条書き --></ul></li>
      <li>地域・生活：<ul><!-- 箇条書き --></ul></li>
      <li>行政・政治改革：<ul><!-- 箇条書き --></ul></li>
    </ul>
  </li>
  <li>■財源・実施スケジュール：{{情報未提供 も可}}</li>
  <li>■実績・背景：<ul><!-- 事実のみ --></ul></li>
  <li>■論点・留意事項（中立）：<ul><li><!-- 1〜3点 --></li></ul></li>
  <li>■出典：
    <ol>
      <li><a href="{{URL1}}" target="_blank" rel="noopener">公式/報道1</a></li>
      <li><a href="{{URL2}}" target="_blank" rel="noopener">公式/報道2</a></li>
      <li><a href="{{URL3}}" target="_blank" rel="noopener">公式/報道3</a></li>
    </ol>
  </li>
  <li>最終更新：<time datetime="2025-10-21">2025-10-21</time></li>
</ul>
`

userPrompt = `
役割: あなたは中立な編集者です。以下の「検証済み事実情報」に加え、必ず web_search を用いて一次・公的ソースを優先的に収集し、推測や創作をせずに、2025年参議院選挙（兵庫県選挙区）候補者「泉 房穂」のマニフェストを、シンプルなリストHTMLのみで作成してください。

# 行動方針（web_searchの必須利用）
1) データ収集:
   - web_search を用いて、以下の順にソースを探索・採用（重視順）:
     a. 兵庫県選挙管理委員会・総務省「選挙公報」公式PDF/ページ
     b. 候補者の公式サイト、広報物、SNS（X/Facebook/YouTubeの政見放送等）
     c. 公的機関・放送局・全国紙・地方紙・通信社（NHK、総務省、自治体、共同通信、時事、毎日、朝日、読売、神戸新聞等）
   - 2024-01-01 〜 {{2025-10-25}}（JST）に公開・更新された情報を優先。古い情報は採用しないか、文脈に注意して扱う。
   - 3〜8件の信頼できるソースに限定。重複・再転載は除外。
   - web_search の実行時は、「泉 房穂 マニフェスト」「公約」「選挙公報」「政策」「兵庫 参院 2025」「政見放送」等のクエリを複合的に使用。

2) 事実抽出:
   - 各ソースから「公約・政策として明示された文言」のみを抽出。
   - 抽出は短い引用（最大20語程度）に留め、<q>で引用し、URLと日付（<time>）を必ず併記できるように記録。
   - 数値・固有名詞はソースに一致する場合のみ採用。曖昧な記述は採用しない。

3) 矛盾・不足の扱い:
   - ソース間で内容が矛盾する場合は、いずれか一方を選ばず「論点・留意事項」に中立的に記載し、各ソースを併記。
   - 必要情報が見つからない場合は「情報未提供」と明記。

4) ハルシネーション防止チェック（出力直前の自己検証）:
   - 出力内のすべての主張が少なくとも1つの採用ソースで検証可能か確認。
   - 出典に無い数値・地名・肩書・日付・略称が出力に紛れていないか確認。
   - 推測語（例：「おそらく」「想定」「〜と考えられる」）が入っていないことを確認。

# 入力として与える検証済み事実情報（この範囲から外れないこと）
- 選挙名: {{第27回参議院議員通常選挙}}
- 年: {{2025}}
- 選挙区: {{兵庫県}}
- 候補者: {{泉 房穂}}
- 所属: {{無所属／政党名／情報未提供}}

# 出力制約（非常に重要）
- 出力は HTML のうち <ul>/<ol>/<li> のみを使用（必要に応じ <a>, <time>, <q> は可）。
- 見出しタグ（h1等）・p・div・span・スタイル・コメント・スクリプトは禁止。
- 日本語で簡潔に記述。
- ソースは <a> タグでURLを明示。日付は <time datetime="YYYY-MM-DD">YYYY-MM-DD</time> で併記。
- 引用は短くし、<q>内に収める。

# 出力構成（順序・入れ子を厳守）
<ul>
  <li>タイトル：{{2025}}年 / {{兵庫県}} / {{泉 房穂}}</li>
  <li>要約：
    <ul>
      <li>事実情報とweb_searchで確認できた要点を3〜5行で簡潔に</li>
    </ul>
  </li>
  <li>主要公約：
    <ul>
      <!-- 最大7項目。各項目は要約文 + （必要に応じ短い<q>引用 と <a>URL と <time>） -->
    </ul>
  </li>
  <li>具体策：
    <ul>
      <li>経済・物価：<ul><!-- 具体策を箇条書き。各項目に根拠ソースを付与 --></ul></li>
      <li>子育て・教育：<ul><!-- 同上 --></ul></li>
      <li>社会保障：<ul><!-- 同上 --></ul></li>
      <li>地域・生活：<ul><!-- 同上 --></ul></li>
      <li>行政・政治改革：<ul><!-- 同上 --></ul></li>
    </ul>
  </li>
  <li>財源・実施スケジュール：{{情報未提供 または 根拠付きで簡潔に}}</li>
  <li>実績・背景：
    <ul>
      <!-- 候補者の公的実績・経歴に基づく簡潔な要素。出典必須。無ければ「情報未提供」。 -->
    </ul>
  </li>
  <li>論点・留意事項（中立）：
    <ul>
      <li><!-- 矛盾・未確定・批判/評価などを中立に1〜3点。各点に出典 --></li>
    </ul>
  </li>
  <li>出典：
    <ol>
      <!-- 採用ソース（3〜8件）。公式・公的・有力報道を優先。各<li>に<a>と<time> -->
    </ol>
  </li>
  <li>最終更新：<time datetime="{{YYYY-MM-DD}}">{{YYYY-MM-DD}}</time></li>
</ul>

# 例外時の挙動
- web_search で主要公約の一次情報（選挙公報・公式声明等）が得られない場合：
  - 「主要公約」は空欄にせず、<li>情報未提供</li> と明記。
  - 二次報道のみで断定表現は使用しない。「〜と報じられている」と要約し、出典を明記。

# 実行メモ（実装者向け推奨だが出力には含めない）
- 同一ソース内の更新版/再掲版は最新日付を優先。
- SNSはなりすまし防止のため、公式サイトや認証アカウントからのリンクで真正性を確認。
- PDFは発行主体・発行日を必ず確認（<time>に反映）。
`

userPrompt = `
役割: あなたは中立な編集者です。以下の「検証済み事実情報」に加え、必ず web_search を用いて一次・公的ソースを優先的に収集し、推測や創作をせずに、2025年参議院選挙（兵庫県選挙区）候補者「泉 房穂」のマニフェストを、シンプルなリストHTMLのみで作成してください。

# 行動方針（web_searchの必須利用）
1) データ収集:
   - web_search を用いて、以下の順にソースを探索・採用（重視順）:
     a. 兵庫県選挙管理委員会・総務省「選挙公報」公式PDF/ページ
     b. 候補者の公式サイト、広報物、SNS（X/Facebook/YouTubeの政見放送等）
     c. 公的機関・放送局・全国紙・地方紙・通信社（NHK、総務省、自治体、共同通信、時事、毎日、朝日、読売、神戸新聞等）
   - 2024-01-01 〜 2025-10-25（JST）に公開・更新された情報を優先。古い情報は採用しないか、文脈に注意して扱う。
   - 3〜8件の信頼できるソースに限定。重複・再転載は除外。
   - web_search の実行時は、「泉 房穂 マニフェスト」「公約」「選挙公報」「政策」「兵庫 参院 2025」「政見放送」等のクエリを複合的に使用。

2) 事実抽出:
   - 各ソースから「公約・政策として明示された文言」のみを抽出。
   - 抽出は短い引用（最大20語程度）に留め、<q>で引用し、URLと日付（<time>）を必ず併記できるように記録。
   - 数値・固有名詞はソースに一致する場合のみ採用。曖昧な記述は採用しない。

3) 矛盾・不足の扱い:
   - ソース間で内容が矛盾する場合は、いずれか一方を選ばず「論点・留意事項」に中立的に記載し、各ソースを併記。
   - 必要情報が見つからない場合は「情報未提供」と明記。

4) ハルシネーション防止チェック（出力直前の自己検証）:
   - 出力内のすべての主張が少なくとも1つの採用ソースで検証可能か確認。
   - 出典に無い数値・地名・肩書・日付・略称が出力に紛れていないか確認。
   - 推測語（例：「おそらく」「想定」「〜と考えられる」）が入っていないことを確認。

# 入力として与える検証済み事実情報（この範囲から外れないこと）
- 選挙名: 第27回参議院議員通常選挙
- 年: 2025
- 選挙区: 兵庫県
- 候補者: 泉 房穂
- 所属: 無所属／政党名／情報未提供

# 出力制約（非常に重要）
- 出力は HTML のうち <ul>/<ol>/<li> のみを使用（必要に応じ <a>, <time>, <q> は可）。
- 見出しタグ（h1等）・p・div・span・スタイル・コメント・スクリプトは禁止。
- 日本語で簡潔に記述。
- ソースは <a> タグでURLを明示。日付は <time datetime="YYYY-MM-DD">YYYY-MM-DD</time> で併記。
- 引用は短くし、<q>内に収める。

# 出力構成（順序・入れ子を厳守）
<ul>
  <li>タイトル：2025年 / 兵庫県 / 泉 房穂</li>
  <li>要約：
    <ul>
      <li>事実情報とweb_searchで確認できた要点を3〜5行で簡潔に</li>
    </ul>
  </li>
  <li>主要公約：
    <ul>
      <!-- 最大7項目。各項目は要約文 + （必要に応じ短い<q>引用 と <a>URL と <time>） -->
    </ul>
  </li>
  <li>具体策：
    <ul>
      <li>経済・物価：<ul><!-- 具体策を箇条書き。各項目に根拠ソースを付与 --></ul></li>
      <li>子育て・教育：<ul><!-- 同上 --></ul></li>
      <li>社会保障：<ul><!-- 同上 --></ul></li>
      <li>地域・生活：<ul><!-- 同上 --></ul></li>
      <li>行政・政治改革：<ul><!-- 同上 --></ul></li>
    </ul>
  </li>
  <li>財源・実施スケジュール：{{情報未提供 または 根拠付きで簡潔に}}</li>
  <li>実績・背景：
    <ul>
      <!-- 候補者の公的実績・経歴に基づく簡潔な要素。出典必須。無ければ「情報未提供」。 -->
    </ul>
  </li>
  <li>論点・留意事項（中立）：
    <ul>
      <li><!-- 矛盾・未確定・批判/評価などを中立に1〜3点。各点に出典 --></li>
    </ul>
  </li>
  <li>出典：
    <ol>
      <!-- 採用ソース（3〜8件）。公式・公的・有力報道を優先。各<li>に<a>と<time> -->
    </ol>
  </li>
  <li>最終更新：<time datetime="{{YYYY-MM-DD}}">{{YYYY-MM-DD}}</time></li>
</ul>

# 例外時の挙動
- web_search で主要公約の一次情報（選挙公報・公式声明等）が得られない場合：
  - 「主要公約」は空欄にせず、<li>情報未提供</li> と明記。
  - 二次報道のみで断定表現は使用しない。「〜と報じられている」と要約し、出典を明記。

# 実行メモ（実装者向け推奨だが出力には含めない）
- 同一ソース内の更新版/再掲版は最新日付を優先。
- SNSはなりすまし防止のため、公式サイトや認証アカウントからのリンクで真正性を確認。
- PDFは発行主体・発行日を必ず確認（<time>に反映）。
`

userPrompt = `
役割: あなたは中立な編集者です。以下の「検証済み事実情報」だけを根拠に、2025年参院選に出馬の「泉房穂」のマニフェストを、シンプルなリストHTMLのみで作成してください。

出力制約:
- <ul>/<ol>/<li>のみ使用（必要に応じ<a>, <time>, <q>可）。見出しタグや<p>、スタイル、コメントは使わない。
- 事実情報に無い記述は禁止。不足は「情報未提供」と明記。
- 数値・固有名詞は出典と一致する場合のみ。
- 引用は短く<q>で可（出典URL・日付を併記）。

検証済み事実情報:
- 選挙名: 参議院選挙
- 年: 2025
- 候補者: 泉房穂
- 所属: 無所属

出力構成（この順番・入れ子を厳守）:
<ul>
  <li>■要約：<ul><li><!-- 3〜5行 --></li></ul></li>
  <li>■公約：<ul><!-- 最大7項目 --></ul></li>
  <li>■具体策：
    <ul>
      <li>経済・物価：<ul><!-- 箇条書き --></ul></li>
      <li>子育て・教育：<ul><!-- 箇条書き --></ul></li>
      <li>社会保障：<ul><!-- 箇条書き --></ul></li>
      <li>地域・生活：<ul><!-- 箇条書き --></ul></li>
      <li>行政・政治改革：<ul><!-- 箇条書き --></ul></li>
    </ul>
  </li>
  <li>■財源・実施スケジュール：{{情報未提供 も可}}</li>
  <li>■実績・背景：<ul><!-- 事実のみ --></ul></li>
  <li>■論点・留意事項（中立）：<ul><li><!-- 1〜3点 --></li></ul></li>
  <li>■出典：
    <ol>
      <li><a href="{{URL1}}" target="_blank" rel="noopener">公式/報道1</a></li>
      <li><a href="{{URL2}}" target="_blank" rel="noopener">公式/報道2</a></li>
      <li><a href="{{URL3}}" target="_blank" rel="noopener">公式/報道3</a></li>
    </ol>
  </li>
  <li>最終更新：<time datetime="2026-01-04">2026-01-04</time></li>
</ul>
`

const response = await client.responses.create({
  model: "gpt-5",
  reasoning: { effort: "medium" },
  tools: [{ type: "web_search" }],
  input: userPrompt,
})

console.log(response.output_text)
